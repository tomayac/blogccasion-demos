<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="origin-trial"
      content="AvKXZEAcZSd7J6+HLZsuZ4AF4+rtIB9u1LUCRiB+3HvhiP1ncm1OIjTqb3h/bUobHYJA1qAyGYuQ0iGwxJt1rQ8AAABleyJvcmlnaW4iOiJodHRwczovL3RvbWF5YWMuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJBSVByb21wdEFQSU11bHRpbW9kYWxJbnB1dCIsImV4cGlyeSI6MTc3NDMxMDQwMH0="
    />
    <title>Canvas Clock</title>
    <style>
      :root {
        font-family: system-ui;
        --color-scheme: dark;
        color-scheme: var(--color-scheme);
      }
      body {
        place-items: center;
      }
      canvas,
      output {
        display: block;
      }
      output {
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div>
      <label
        >Use red font
        <input type="checkbox" id="colorSwitch" />
      </label>
      <label
        >Use light theme
        <input type="checkbox" id="themeSwitch" />
      </label>
    </div>
    <canvas id="clockCanvas" width="450" height="200"></canvas>
    <output id="aiOutput"></output>
    <script type="module">
      (async () => {
        const canvas = document.getElementById('clockCanvas');
        const output = document.getElementById('aiOutput');
        const colorSwitch = document.getElementById('colorSwitch');
        const themeSwitch = document.getElementById('themeSwitch');

        if (!('LanguageModel' in self)) {
          output.textContent = 'Your browser does not support the Prompt API.';
          return;
        }

        const options = {
          expectedInputs: [
            {
              type: 'image',
            },
            {
              type: 'text',
              languages: ['en'],
            },
          ],
          expectedOutputs: [
            {
              type: 'text',
              languages: ['en'],
            },
          ],
        };

        if ((await LanguageModel.availability(options)) === 'unavailable') {
          output.textContent =
            'Your browser does not support the Prompt API with image input.';
          return;
        }

        const ctx = canvas.getContext('2d');
        ctx.font = '100px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const x = canvas.width / 2;
        const y = canvas.height / 2;

        themeSwitch.addEventListener('change', () => {
          document.documentElement.style.setProperty(
            '--color-scheme',
            themeSwitch.checked ? 'light' : 'dark'
          );
        });

        const mainSession = await LanguageModel.create(options);

        function drawTime() {
          const now = new Date();

          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');

          const timeString = `${hours}:${minutes}:${seconds}`;
          const colorScheme = getComputedStyle(canvas).colorScheme;
          ctx.fillStyle = colorSwitch.checked
            ? themeSwitch.checked
              ? 'white'
              : '#000000'
            : colorScheme === 'dark'
              ? '#000000'
              : 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = colorSwitch.checked
            ? 'red'
            : colorScheme === 'dark'
              ? 'white'
              : '#000000';

          ctx.fillText(timeString, x, y);

          return timeString;
        }

        async function readTime() {
          const timeString = drawTime();

          const session = await mainSession.clone();
          const stream = session.promptStreaming(
            [
              {
                role: 'user',
                content: [
                  {
                    type: 'image',
                    value: canvas,
                  },
                  {
                    type: 'text',
                    value:
                      'Read the time that you can see in this image and print it in HH:mm:ss format.',
                  },
                ],
              },
            ],
            {
              responseConstraint:
                /^([0-1][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])$/,
            }
          );

          output.textContent += '\n';
          let result = '';
          for await (const chunk of stream) {
            output.append(chunk);
            result += chunk;
          }
          output.append(` ${result === timeString ? '✅' : '❌'}`);

          await readTime();
        }

        await readTime();
      })();
    </script>
  </body>
</html>
